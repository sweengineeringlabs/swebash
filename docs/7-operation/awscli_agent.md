# @awscli Agent

> **TLDR:** User-level AWS Cloud agent with pre-loaded reference docs generated from the live AWS CLI.

**Audience**: Users, DevOps

**WHAT**: A custom AI agent for AWS infrastructure tasks, powered by locally generated reference documentation
**WHY**: Provides accurate, version-matched AWS guidance without web access — all context comes from the user's installed CLI tools
**HOW**: YAML agent definition in `~/.config/swebash/agents.yaml` with docs generated by `./sbh gen-aws-docs`

---

## Table of Contents

- [Overview](#overview)
- [Prerequisites](#prerequisites)
- [Setup](#setup)
- [Agent Configuration](#agent-configuration)
- [Reference Docs Pipeline](#reference-docs-pipeline)
- [Usage](#usage)
- [Environment Variables](#environment-variables)
- [Troubleshooting](#troubleshooting)

## Overview

`@awscli` is a user-level agent (not built-in) that assists with AWS CLI commands, CloudFormation, CDK, SAM, and Terraform. It uses three locally generated reference documents as pre-loaded context, so it can provide accurate, version-matched guidance without web search.

The agent is defined in the user's `~/.config/swebash/agents.yaml` and its reference docs are generated from the live `aws` CLI help output by `./sbh gen-aws-docs`.

## Prerequisites

| Requirement | Purpose |
|-------------|---------|
| AWS CLI v2 | Source for reference doc generation |
| `~/.config/swebash/agents.yaml` | Agent definition file (see [Creating Agents](creating_agents.md)) |
| An AI provider configured | `ANTHROPIC_API_KEY` or `OPENAI_API_KEY` (see [Configuration](configuration.md)) |

Optional tools that enrich the generated docs:

| Tool | Enriches |
|------|----------|
| AWS CDK (`cdk`) | `iac_patterns.md` with live CDK help |
| AWS SAM (`sam`) | `iac_patterns.md` with live SAM help |
| Terraform (`terraform`) | `iac_patterns.md` with live Terraform help |

## Setup

### 1. Generate reference docs

```bash
./sbh gen-aws-docs
```

This runs `bin/gen-aws-docs.sh`, which:

1. Queries `aws <service> help` for 13 services (ec2, s3, lambda, iam, cloudformation, ecs, eks, rds, dynamodb, sqs, sns, cloudwatch, route53)
2. Extracts synopsis, description, and key subcommands from each service
3. Generates IaC patterns from CloudFormation, CDK, SAM, and Terraform help output
4. Generates a troubleshooting guide with auth diagnostics, debug techniques, and common errors
5. Writes 3 markdown files to `~/.config/swebash/docs/aws/`

If `aws` is not installed, the script offers an interactive installer (local `~/.local` or system `/usr/local`).

### 2. Define the agent

Add the `awscli` agent entry to `~/.config/swebash/agents.yaml`. See [Agent Configuration](#agent-configuration) below for the full definition.

### 3. Verify

```bash
# Check agent appears in listing
ai agents

# Check docs load without warnings
# (stderr should NOT contain "agent=awscli" unresolved docs warnings)
```

## Agent Configuration

The `@awscli` agent definition in `~/.config/swebash/agents.yaml`:

```yaml
version: 1
agents:
  - id: awscli
    name: AWS Cloud Assistant
    description: AWS CLI commands, CloudFormation, CDK, SAM, and Terraform
    maxIterations: 25
    triggerKeywords:
      - aws
      - s3
      - ec2
      - lambda
      - cloudformation
      - terraform
    tools:
      fs: true
      exec: true
      web: false
    docs:
      budget: 12000
      sources:
        - services_reference.md
        - iac_patterns.md
        - troubleshooting.md
    systemPrompt: |
      You are an AWS Cloud assistant embedded in swebash.
      ...
```

### Key settings

| Field | Value | Rationale |
|-------|-------|-----------|
| `maxIterations` | `25` | AWS tasks often require multiple tool calls (list, describe, create) |
| `tools.web` | `false` | All context comes from pre-loaded docs — no web search needed |
| `tools.fs` | `true` | Read CloudFormation templates, Terraform configs, CDK code |
| `tools.exec` | `true` | Execute `aws`, `cdk`, `sam`, `terraform` commands |
| `docs.budget` | `12000` | Token budget for loading reference docs (~12k tokens across 3 files) |

## Reference Docs Pipeline

### Generated files

| File | Content | Source |
|------|---------|--------|
| `services_reference.md` | Synopsis and key subcommands for 13 AWS services | `aws <service> help` |
| `iac_patterns.md` | CloudFormation, CDK, SAM, Terraform usage patterns | `aws cloudformation help`, `cdk --help`, `sam --help`, `terraform --help` |
| `troubleshooting.md` | Auth diagnostics, debug techniques, common error tables | `aws sts help`, static patterns |

### Output location

```
~/.config/swebash/docs/aws/
├── services_reference.md
├── iac_patterns.md
└── troubleshooting.md
```

Configurable via `SWEBASH_AWS_DOCS_DIR` (defaults to `~/.config/swebash/docs/aws`).

### Budget control

Each file is capped at ~15,000 characters (`CHAR_BUDGET` in `gen-aws-docs.sh`). Total target is under 48k characters (~12k tokens) to fit within the agent's `docs.budget: 12000` token allocation.

### Refreshing docs

Re-run `./sbh gen-aws-docs` after upgrading the AWS CLI or installing new IaC tools to regenerate docs with updated help output. **Restart swebash after regenerating** — document content is loaded once at startup and baked into the agent's system prompt for the session.

## Usage

```bash
# From shell mode — one-shot query
ai @awscli how do I create an S3 bucket with versioning?

# From shell mode — enter AI mode with awscli agent
ai @awscli

# From AI mode — switch to awscli agent
@awscli

# Auto-detection (if a trigger keyword is in the input)
# Typing "deploy my lambda" in AI mode auto-switches to @awscli
```

### Example interactions

```
[AI:awscli] > list all S3 buckets and their sizes
[AI:awscli] > create a CloudFormation stack from template.yaml
[AI:awscli] > why is my Lambda timing out?
[AI:awscli] > set up a new ECS Fargate service
[AI:awscli] > diagnose this AccessDenied error
```

## Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `SWEBASH_AWS_DOCS_DIR` | `~/.config/swebash/docs/aws` | Output directory for generated reference docs |
| `SWEBASH_AI_DOCS_BASE_DIR` | `~/.config/swebash` | Base directory for agent doc resolution (the `docs/aws/` path is relative to this) |
| `SWEBASH_AGENTS_CONFIG` | *(none)* | Explicit path to agents YAML file (overrides default lookup) |

## Troubleshooting

| Problem | Cause | Fix |
|---------|-------|-----|
| `@awscli` not in `ai agents` | Agent not defined in YAML | Add the agent entry to `~/.config/swebash/agents.yaml` |
| "unresolved docs" warnings on startup | Reference docs not generated | Run `./sbh gen-aws-docs` |
| `gen-aws-docs` fails with "aws not found" | AWS CLI not installed | Run the script interactively — it offers guided installation |
| Docs missing CDK/SAM/Terraform sections | Those tools not installed locally | Install the tools, then re-run `./sbh gen-aws-docs` |
| Stale CLI references in agent responses | Docs generated from old CLI version | Re-run `./sbh gen-aws-docs` to regenerate from current CLI |
| Agent auto-detects too often | Trigger keywords like "aws" are common | Remove broad keywords from `triggerKeywords` list |

## See Also

- [Creating Agents](creating_agents.md) — Full YAML schema and examples for custom agents
- [Configuration](configuration.md) — AI provider setup and environment variables
- [Agent Architecture](../3-design/agent_architecture.md) — How agents, tools, and docs work together
- [ADR-001](../3-design/ADR-001-agent-doc-context.md) — Agent documentation context strategy
